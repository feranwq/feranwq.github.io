
<!DOCTYPE html>
<html lang="zh-CN" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>feran&#39;s blog</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="feran,"> 
    
    <meta name="author" content="feran"> 
    <link rel="alternative" href="atom.xml" title="feran&#39;s blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="/css/diaspora.css">

</head>
<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">ansible基础.md</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div>
        <h1 class="title">ansible基础.md</h1>
        <div class="stuff">
            <span>五月 11, 2016</span>
        </div>
        <div class="content markdown">
            <h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main&quot; &gt;&gt; /etc/apt/sources.list</span><br><span class="line">$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 93C4A3FD7BB9C367</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<h4 id="Ansible如何通过SSH与远程计算机进行通信的？"><a href="#Ansible如何通过SSH与远程计算机进行通信的？" class="headerlink" title="Ansible如何通过SSH与远程计算机进行通信的？"></a>Ansible如何通过SSH与远程计算机进行通信的？</h4><p>默认情况下，Ansible 1.3或以后的版本默认使用原生OpenSSH进行远程通信。</p>
<ul>
<li>启用ControlPersist模块 (a performance feature)(开启SSH的ControlMaster并持久化socket连接，可以加速Ansible的执行速度，不需要在每次都经历SSH认证，单个服务器可能节约的时间仅在1秒左右，而上百台的服务器就能节省约1分钟左右的时间。)</li>
<li>启用Kerberos(安全模块)</li>
<li>另外还会启动<code>~/.ssh/config</code>的一些配置选项例如Jump Host配置</li>
<li>Kerberized </li>
</ul>
<p>REDHAT6/CENTOS6由于openssh版本太低,会启用paramiko来通信,Kerberized SSH也可以用 Accelerated Mode来启用</p>
<p>1.2和以前的版本都是基于paramiko的,需要手动配置选择原生OpenSSH</p>
<p>偶尔会遇到不知sftp的机器,在配置文件里改为scp模式即可</p>
<p>默认使用SSH密钥连接,可以手动改为通过密码(不推荐).如果使用sudo功能，当sudo需要密码时，还要提供<code>--ask-become-pass</code></p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>把ansible的公钥下发到被控端,<code>ssh-keygen -t rsa</code>生成,<code>ssh-copy-id 被控端IP</code>下发公钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">修改ansible/hosts配置文件</span><br><span class="line">cat /etc/ansible/hosts</span><br><span class="line">[webservers]</span><br><span class="line">web1</span><br><span class="line">web2</span><br><span class="line">[haproxys]</span><br><span class="line">haproxy1</span><br><span class="line">haproxy2</span><br><span class="line"></span><br><span class="line"># 测试连接</span><br><span class="line">ansible all -m ping</span><br><span class="line">web1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line"># 以用户bruce登录</span><br><span class="line">$ ansible all -m ping -u bruce</span><br><span class="line"># 以用户bruce登录，还要sudo到root</span><br><span class="line">$ ansible all -m ping -u bruce --sudo</span><br><span class="line"># 以用户bruce登录，还要sudo到用户batman</span><br><span class="line">$ ansible all -m ping -u bruce --sudo --sudo-user batman</span><br><span class="line"></span><br><span class="line"># 在最新版的Ansible中不再支持`sudo`了，最好用become参数</span><br><span class="line"># 以用户bruce登录，还要sudo到root</span><br><span class="line">$ ansible all -m ping -u bruce -b</span><br><span class="line"># 以用户bruce登录，还要sudo到用户batman</span><br><span class="line">$ ansible all -m ping -u bruce -b --become-user batman</span><br><span class="line"></span><br><span class="line">#试着执行一条命令</span><br><span class="line">$ ansible all -a &quot;/bin/echo hello&quot;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>:如果一个被控端重做了系统，它的密钥和主控端中的“known_hosts”里面保存的那个就不一样了，此时主控端这边便会报错。如果确定关闭密钥校验，可以修改Ansible的配置文件<code>/etc/ansible/ansible.cfg</code>或者<code>~/.ansible.cfg</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">host_key_checking = False</span><br></pre></td></tr></table></figure>
<h4 id="Inventory-主机清单"><a href="#Inventory-主机清单" class="headerlink" title="Inventory(主机清单)"></a>Inventory(主机清单)</h4><p>ansible通过Inventory来管理被控端,Inventory默认为/etc/ansible/hosts.可以单独指定为另外的一个或者多个,甚至可以动态获取</p>
<p>主机清单默认写法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 未分组主机</span><br><span class="line">mail.example.com</span><br><span class="line"></span><br><span class="line"># webservers组下的主机</span><br><span class="line">[webservers]</span><br><span class="line">foo.example.com</span><br><span class="line">bar.example.com</span><br><span class="line">www[01:50].example.com # 批量</span><br><span class="line"></span><br><span class="line"># dbservers组下的主机</span><br><span class="line">[dbservers]</span><br><span class="line">one.example.com</span><br><span class="line">two.example.com</span><br><span class="line">three.example.com</span><br><span class="line">db-[a:f].example.com # 批量</span><br></pre></td></tr></table></figure></p>
<p>YAML写法(推荐)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">all:</span><br><span class="line">  hosts:</span><br><span class="line">    mail.example.com</span><br><span class="line">  children:</span><br><span class="line">    webservers:</span><br><span class="line">      hosts:</span><br><span class="line">        foo.example.com:</span><br><span class="line">        bar.example.com:</span><br><span class="line">        www[01:50].example.com:</span><br><span class="line">    dbservers:</span><br><span class="line">      hosts:</span><br><span class="line">        one.example.com:</span><br><span class="line">        two.example.com:</span><br><span class="line">        three.example.com:</span><br><span class="line">        db-[a:f].example.com:</span><br></pre></td></tr></table></figure></p>
<p>针对反向ssh主机配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 被控端主机名-连接端口-连接IP</span><br><span class="line">jumper ansible_port=5555 ansible_host=192.0.2.50</span><br></pre></td></tr></table></figure></p>
<p>YAML格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hosts:</span><br><span class="line">  jumper:</span><br><span class="line">    ansible_port: 5555</span><br><span class="line">    ansible_host: 192.0.2.50</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注:ansible_user, ansible_host, ansible_port都是内置变量,2.0版本以前为ansible_ssh_user, ansible_ssh_host, and ansible_ssh_port,<a href="http://docs.ansible.com/ansible/latest/intro_inventory.html#list-of-behavioral-inventory-parameters" target="_blank" rel="noopener">更多详情</a></p>
</blockquote>
<p>给主机单独定义变量(优先级最高)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">host1 http_port=80 maxRequestsPerChild=808</span><br><span class="line">host2 http_port=303 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure></p>
<p>给组定义变量,所有的主机都会继承(回被覆盖,一个主机可以属于多个组,优先级顺序目前不明,待更)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br><span class="line">[atlanta:vars]</span><br><span class="line">ntp_server=ntp.atlanta.example.com</span><br><span class="line">proxy=proxy.atlanta.example.com</span><br></pre></td></tr></table></figure></p>
<p>YAML格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">atlanta:</span><br><span class="line">  hosts:</span><br><span class="line">    host1:</span><br><span class="line">    host2:</span><br><span class="line">  vars:</span><br><span class="line">    ntp_server: ntp.atlanta.example.com</span><br><span class="line">    proxy: proxy.atlanta.example.com</span><br></pre></td></tr></table></figure></p>
<p><strong>为什么推荐YAML格式?关于嵌套组,个人认为YAML更直观</strong></p>
<p>INI格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">host1</span><br><span class="line">host2</span><br><span class="line"></span><br><span class="line">[raleigh]</span><br><span class="line">host2</span><br><span class="line">host3</span><br><span class="line"></span><br><span class="line">[southeast:children]</span><br><span class="line">atlanta</span><br><span class="line">raleigh</span><br><span class="line"></span><br><span class="line">[southeast:vars]</span><br><span class="line">some_server=foo.southeast.example.com</span><br><span class="line">halon_system_timeout=30</span><br><span class="line">self_destruct_countdown=60</span><br><span class="line">escape_pods=2</span><br><span class="line"></span><br><span class="line">[usa:children]</span><br><span class="line">southeast</span><br><span class="line">northeast</span><br><span class="line">southwest</span><br><span class="line">northwest</span><br></pre></td></tr></table></figure></p>
<p>YAML格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">all:</span><br><span class="line">  children:</span><br><span class="line">    usa:</span><br><span class="line">      children:</span><br><span class="line">        southeast:</span><br><span class="line">          children:</span><br><span class="line">            atlanta:</span><br><span class="line">              hosts:</span><br><span class="line">                host1:</span><br><span class="line">                host2:</span><br><span class="line">            raleigh:</span><br><span class="line">              hosts:</span><br><span class="line">                host2:</span><br><span class="line">                host3:</span><br><span class="line">          vars:</span><br><span class="line">            some_server: foo.southeast.example.com</span><br><span class="line">            halon_system_timeout: 30</span><br><span class="line">            self_destruct_countdown: 60</span><br><span class="line">            escape_pods: 2</span><br><span class="line">       northeast:</span><br><span class="line">       northwest:</span><br><span class="line">       southwest:</span><br></pre></td></tr></table></figure></p>
<ul>
<li>父组-子组-主机三个角色</li>
<li>一旦一个组成为子组,那么组下的主机也属于父组</li>
<li>子组的变量有更高的优先级</li>
<li>每个组可以有多个父组也可以有多个子组,但不是循环关系</li>
<li>主机可以属于多个组,最终会把所有数据合成</li>
</ul>
<p>默认组</p>
<p>有两个默认组分别是 <code>all</code> 和 <code>ungrouped</code>.<code>all</code>包含所有主机, <code>ungrouped</code>包含所有没有属组的主机,他们总是存在的,但是不会显示在<code>group_names</code>中</p>
<p><strong>主机和组的变量解耦</strong></p>
<p>不要将变量存在主inventory(/etc/ansible/hosts)文件中,把变量解耦到配置文件,如下例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># /etc/ansible/hosts</span><br><span class="line">all:</span><br><span class="line">  children:</span><br><span class="line">    raleigh:</span><br><span class="line">      hosts:</span><br><span class="line">        foosball</span><br><span class="line">    webservers:</span><br><span class="line">      hosts:</span><br><span class="line">        foosball</span><br><span class="line">        </span><br><span class="line"># /etc/ansible/group_vars/raleigh.yml</span><br><span class="line">---</span><br><span class="line">ntp_server: acme.example.org</span><br><span class="line"></span><br><span class="line"># /etc/ansible/group_vars/webservers.yml</span><br><span class="line">---</span><br><span class="line">database_server: storage.example.org</span><br><span class="line"></span><br><span class="line"># /etc/ansible/host_vars/foosball.yml </span><br><span class="line">zabbix_server: zabbix.example.org</span><br><span class="line"></span><br><span class="line"># 也可以把组定义成目录,再解耦</span><br><span class="line"># /etc/ansible/group_vars/raleigh/db_settings.yml</span><br><span class="line"># /etc/ansible/group_vars/raleigh/cluster_settings.yml</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>group_vars</code>和<code>host_vars</code>目录从1.2之后支持,定义组目录从1.4之后支持</p>
</blockquote>
<p><strong>最好把inventory(主文件和变量文件)维护在git或者其他版本控制工具之中</strong></p>
<h4 id="动态获取主机清单"><a href="#动态获取主机清单" class="headerlink" title="动态获取主机清单"></a>动态获取主机清单</h4><p>待更新</p>
<h4 id="Patterns"><a href="#Patterns" class="headerlink" title="Patterns"></a>Patterns</h4><p>在ansible里用Patterns来定义要控制的终端，其实就是指定命令下发给哪些机器,可以理解为通过特定语法把目标主机加到临时组Patterns来批量控制</p>
<p>下面的例子webservers组就是patterns</p>
<p><code>ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; -a &lt;arguments&gt;</code></p>
<p><code>ansible webservers -m service -a &quot;name=httpd state=restarted&quot;</code></p>
<p>下面来看一下patterns的语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">all                                      # 所有</span><br><span class="line">*                                        # 所有</span><br><span class="line">one.example.com                          # 指定单个主机</span><br><span class="line">one.example.com:two.example.com          # 指定主机one加two(都会执行)</span><br><span class="line">192.0.2.50                               # 通过IP</span><br><span class="line">192.0.2.*                                # 通过IP段</span><br><span class="line">webservers                               # 指定主机组</span><br><span class="line">webservers:dbservers                     # 指定webservers组加dbservers组</span><br><span class="line">webservers:!phoenix                      # 在webservers组但是不在phoenix组中的主机</span><br><span class="line">webservers:&amp;staging                      # 同时在webservers组和staging组的主机</span><br><span class="line">webservers:dbservers:&amp;staging:!phoenix   # (webservers组加dbservers组的主机)同时在staging组并且不在phoenix</span><br><span class="line">one*.com:dbservers                       # 主机名和组混用</span><br><span class="line">~(web|db).*\.example\.com                # ~开头启用正则</span><br><span class="line">ansible-playbook site.yml --limit datacenter2 # 在命令行里可以用--limit来单独排除</span><br><span class="line">ansible-playbook site.yml --limit @retry_hosts.txt # 排除retry_hosts.txt里的主机</span><br></pre></td></tr></table></figure></p>
<h2 id="Introduction-To-Ad-Hoc-Commands-临时-快速命令"><a href="#Introduction-To-Ad-Hoc-Commands-临时-快速命令" class="headerlink" title="Introduction To Ad-Hoc Commands(临时/快速命令)"></a>Introduction To Ad-Hoc Commands(临时/快速命令)</h2><h4 id="SHELL和COMMAND"><a href="#SHELL和COMMAND" class="headerlink" title="SHELL和COMMAND"></a>SHELL和COMMAND</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># -a 执行的命令 </span><br><span class="line"># -m 默认是command,可以省略.但是命令里如果有管道|或者重定向&lt;&gt;需要-m指定shell来执行</span><br><span class="line">&lt;注意&gt; -a里需要用单引号来表示变量</span><br><span class="line"># -f 启用N个进程去下发任务,默认5个.可以通过配置文件修改(官方推荐尽量设置高一点Feel free to push this value as high as your system can handle!)</span><br><span class="line"># -u 指定执行命令的用户</span><br><span class="line"># -u username --become  [otheruser] [--ask-become-pass] 指定执行sudu命令的用户,可以指定su其他用户,--ask-become-pass可以进入交互模式以提供sudo密码</span><br><span class="line">root@vps-test-backup:/etc/ansible# time ansible webservers:haproxys -a &quot;/bin/echo hello&quot; -f 4</span><br><span class="line">haproxy1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">web1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">haproxy2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">web2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real	0m1.099s</span><br><span class="line">user	0m0.716s</span><br><span class="line">sys	0m0.144s</span><br><span class="line">root@vps-test-backup:/etc/ansible# time ansible webservers:haproxys -a &quot;/bin/echo hello&quot; -f 1</span><br><span class="line">web1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">web2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">haproxy1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">haproxy2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real	0m1.485s</span><br><span class="line">user	0m0.728s</span><br><span class="line">sys	0m0.140s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@vps-test-backup:/etc/ansible# ansible webservers:haproxys -m shell -a &apos;echo $PATH&apos;</span><br><span class="line"># 正常返回</span><br><span class="line">haproxy2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">web1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/share/jdk1.8.0_161/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">web2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/share/jdk1.8.0_161/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">haproxy1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">root@vps-test-backup:/etc/ansible# ansible webservers:haproxys -m shell -a &quot;echo $PATH&quot;</span><br><span class="line"># 可以看到显示的是ansible本地的PATH变量</span><br><span class="line">web1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"></span><br><span class="line">web2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"></span><br><span class="line">haproxy1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line"></span><br><span class="line">haproxy2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br></pre></td></tr></table></figure>
<h4 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">root@vps-test-backup:/etc/ansible# ansible webservers:haproxys -m copy -a &quot;src=/etc/hosts dest=/tmp/hosts&quot;</span><br><span class="line"># -m copy 复制文件</span><br><span class="line">web1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;e38ae5206830b1c903e032463f63622253f88a45&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/hosts&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;8183b6a55f8569fb597b1ad52345c761&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 326, </span><br><span class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1516949432.32-34449028488535/source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@vps-test-backup:/etc/ansible# ansible webservers -m file -a &quot;dest=/tmp/hosts mode=600 owner=mail group=mail&quot;</span><br><span class="line"># -m file 修改文件或目录权限/所属权</span><br><span class="line">web1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 12, </span><br><span class="line">    &quot;group&quot;: &quot;mail&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0600&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mail&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/hosts&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:admin_home_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 326, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 8</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@vps-test-backup:/etc/ansible# ansible web1 -m file -a &quot;dest=/path/to/c mode=755 state=directory&quot;</span><br><span class="line"># 创建目录,类似mkdir -p</span><br><span class="line">web1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0755&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/path/to/c&quot;, </span><br><span class="line">    &quot;secontext&quot;: &quot;unconfined_u:object_r:default_t:s0&quot;, </span><br><span class="line">    &quot;size&quot;: 6, </span><br><span class="line">    &quot;state&quot;: &quot;directory&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root@vps-test-backup:/etc/ansible# ansible web1 -m file -a &quot;dest=/path/to/c state=absent&quot;</span><br><span class="line"># 递归删除目录</span><br><span class="line">web1 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;path&quot;: &quot;/path/to/c&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="软件包管理"><a href="#软件包管理" class="headerlink" title="软件包管理"></a>软件包管理</h4><p>支持yum和apt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ansible webservers -m yum -a &quot;name=acme state=present&quot;           # 确保acme已安装,不更新</span><br><span class="line">ansible webservers -m yum -a &quot;name=acme-1.5 state=present&quot;       # 确保acme是1.5版本,不更新</span><br><span class="line">ansible webservers -m yum -a &quot;name=acme state=latest&quot;            # 确保acme已安装,更新到最新版本</span><br><span class="line">ansible webservers -m yum -a &quot;name=acme state=absent&quot;            # 确保acme没有安装</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ansible all -m user -a &quot;name=foo password=&lt;crypted password here&gt;&quot; # 创建用户</span><br><span class="line">ansible all -m user -a &quot;name=foo state=absent&quot;                     # 删除用户</span><br><span class="line"></span><br><span class="line">ansible webservers -m git -a &quot;repo=https://foo.example.org/repo.git dest=/srv/myapp version=HEAD&quot; # 直接用git部署应用</span><br></pre></td></tr></table></figure></p>
<h4 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible webservers -m service -a &quot;name=httpd state=started&quot;</span><br><span class="line">ansible webservers -m service -a &quot;name=httpd state=restarted&quot;</span><br><span class="line">ansible webservers -m service -a &quot;name=httpd state=stopped&quot;</span><br></pre></td></tr></table></figure>
<h4 id="限时后台操作"><a href="#限时后台操作" class="headerlink" title="限时后台操作"></a>限时后台操作</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 后台执行命令,超时时间为1800秒,每60秒获取一次状态,超时/执行完成都会结束后台进程</span><br><span class="line">ansible all -B 1800 -P 60 -a &quot;some command&quot;</span><br><span class="line"># 传入任务ID手动查询状态</span><br><span class="line"> ansible web1.example.com -m async_status -a &quot;jid=488359678239.2844&quot;</span><br></pre></td></tr></table></figure>
<h4 id="Gathering-Facts收集机器信息"><a href="#Gathering-Facts收集机器信息" class="headerlink" title="Gathering Facts收集机器信息"></a>Gathering Facts收集机器信息</h4><p><code>ansible all -m setup</code></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="http://link.hhtjim.com/163/425570952.mp3">
            </audio>
        </div>
        
<div class="comment link" data-id="2016/05/11/ansible基础/" data-title="ansible基础.md" data-url="http://blog.feran.top/2016/05/11/ansible基础/" data-shortname="feran">查看评论</div>


    </div>
</div>

    </div>
</div>
</body>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-69833742-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</html>