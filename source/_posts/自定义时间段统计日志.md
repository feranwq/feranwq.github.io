title: 自定义时间段统计日志
date: 2017-12-10 00:08:18
tags: 
mp3: 
cover: http://wx1.sinaimg.cn/large/77b6881dgy1fmc4f1yj15j20xc0rsdgl.jpg
---
此脚本用于统计最近半小时内日志关键词数量,每次运行生成两个时间戳,当前时间和半小时前时间
对文件反读来提高效率,通过re与time模块来筛选符合时间范围内的日志
最后再通过re对筛选过的日志进行关键字统计得出结果


```
# -* coding:utf-8 *-
import time
import re
import logging
import sys

start = time.time()

logging.basicConfig(filename='/var/log/zabbix/tomcat_access_statistics.log',level=logging.ERROR)

class TimeParser(object):
"""
时间对比方法,传入一个起止时间字符串元组,转化为时间格式进行比较,在时间范围内的字符串返回True
"""
    def __init__(self, re_time, str_time, period):
        self.__re_time = re.compile(re_time)
        self.__str_time = str_time
        self.__period = period

    def __get(self, line):
        t= re.search(self.__re_time, line).group(0)
        return time.mktime(time.strptime(t, self.__str_time))

    def inPeriod(self, line):
        t = self.__get(line)
        return (t > time.mktime(time.strptime(self.__period[0], self.__str_time))
                    and t < time.mktime(time.strptime(self.__period[1], self.__str_time)))


def read_reverse(filename):
"""
文件反转
"""
    with open(filename,'rb') as f:
        f.seek(0, 2)
        last_position = f.tell()

        while True:
            line = f.readline()
            current_position = f.tell()
            i = 1
            while current_position == last_position:
                if len(line) == current_position:
                    yield line
                    return
                i += 0.5
                f.seek(max(int(-72 * i), -current_position), 1)
                line = f.readline()
                current_position = f.tell()

            while current_position != last_position:
                line = f.readline()
                current_position = f.tell()

            yield line
            last_position = last_position - len(line)
            f.seek(max(-72, -last_position) - len(line), 1)


def half_hour_get_count():
    global get_count
    global post_count
    get_count = 0
    post_count = 0

    localtime = time.strftime("%d/%b/%Y:%H:%M:%S", time.localtime(time.time())) # '12/Oct/2017:14:50'
    half_hour= time.strftime("%d/%h/%Y:%H:%M:%S", time.localtime(time.time()-1860))
    date_logfilename= time.strftime("%Y-%m-%d", time.localtime(time.time()))

    re_time='\d{2}\/\w{3}\/\d{4}:\d{2}:\d{2}:\d{2}'
    str_time='%d/%b/%Y:%H:%M:%S'
    period=("%s" % half_hour, "%s" % localtime)

    # get_halt_hour_filter = re.compile(r'.*(\d{2}\/\w{3}\/\d{4}:\d{2}:\d{2}:\d{2}).*')
    get_stop_filter = re.compile(r'.*({0}).*'.format(half_hour[0:-3]))
    get_all_filter = re.compile(r'10.162.194.209.*GET /cloud/api/id.*\d?')
    post_all_filter = re.compile(r'10.162.194.209.*POST /cloud/api/id.*\d?')
    CountTime = TimeParser(re_time, str_time, period)
    lines = read_reverse('/opt/apache-tomcat-7.0.39/logs/localhost_access_log.{0}.txt'.format(date_logfilename))
    for i in lines:
        i = str(i)
        if CountTime.inPeriod(i):
            get_all = re.findall(get_all_filter,i)
            post_all = re.findall(post_all_filter,i)
            if get_all:
                get_count += 1
            if post_all:
                post_count += 1
            get_stop = re.findall(get_stop_filter,i)
            if get_stop:
                break
    runtime=time.time()-start
    logging.info(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time())) + "  30分钟内get请求为 {0}, post请求为 {1}, 程序运行费时为 {2:0.2f} 秒".format(get_count,post_count,runtime))






half_hour_get_count()
try:
    if sys.argv[1] == "get":
        print(get_count)
    elif sys.argv[1] == "post":
        print(post_count)
except:
    print("30分钟内get请求为 {0}, post请求为 {1}".format(get_count,post_count))

```